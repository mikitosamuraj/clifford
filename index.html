<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clifford – Music Events</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: Arial; margin:0; padding:1rem; background:#fff; color:#000; }
    header { text-align:center; font-size:24px; margin-bottom:1rem; }
    .top-bar { display:flex; justify-content:space-between; margin-bottom:1rem; }
    .filters { display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap; }
    #map { height:300px; width:100%; margin-bottom:1rem; }
    .event-button, .auth-button { background:red; color:white; padding:0.5rem 1rem; border:none; border-radius:4px; cursor:pointer; }
    .event-form { display:none; margin-bottom:1rem; }
    .event-form input, .event-form select { width:100%; padding:0.5rem; margin:0.3rem 0; }
    .event { background:#000; color:#fff; padding:0.5rem; margin-bottom:0.5rem; border-radius:4px; position:relative; }
    .author-email { font-size:12px; color:#ccc; }
    .action-btn { position:absolute; top:8px; right:8px; background:rgba(255,255,255,0.8); border:none; margin-left:4px; cursor:pointer; }
  </style>
</head>
<body>
<header>Clifford – Music Events</header>

<div class="top-bar">
  <div>
    <button class="auth-button" id="loginBtn">Sign in with Google</button>
    <button class="auth-button" id="logoutBtn" style="display:none;">Sign Out</button>
  </div>
  <button class="event-button" id="toggleFormBtn" disabled>Add Event</button>
</div>

<div class="filters">
  <label><input type="checkbox" id="allGenres" checked> All genres</label>
  <label><input type="checkbox" class="genre" value="Jazz"> Jazz</label>
  <label><input type="checkbox" class="genre" value="Rock"> Rock</label>
  <label><input type="checkbox" class="genre" value="Punk"> Punk</label>
  <label><input type="checkbox" class="genre" value="Metal"> Metal</label>
  <label><input type="checkbox" class="genre" value="DJ"> DJ</label>
  <label><input type="checkbox" class="genre" value="Techno"> Techno</label>
  <label><input type="checkbox" class="genre" value="DNB"> DnB</label>
  <label><input type="checkbox" class="genre" value="Electronic"> Electronic</label>
  <label><input type="checkbox" class="genre" value="Jam Session"> Jam Session</label>
</div>

<div class="event-form" id="eventForm">
  <input type="text" id="eventName" placeholder="Event name" required/>
  <input type="datetime-local" id="eventDateTime" required/>
  <input type="text" id="eventLocation" placeholder="Location" required/>
  <select id="eventGenre" required>
    <option value="">Genre</option><option>Jazz</option><option>Rock</option><option>Punk</option>
    <option>Metal</option><option>DJ</option><option>Techno</option><option>DnB</option>
    <option>Electronic</option><option>Jam Session</option>
  </select>
  <button class="event-button" id="submitEventBtn">Submit</button>
</div>

<div id="map"></div>
<h3>Upcoming Events:</h3>
<div id="eventsList"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBylr8Qgxzw263rInUmln4AYMpibm1t43o",
    authDomain: "clifford-146ae.firebaseapp.com",
    projectId: "clifford-146ae",
    storageBucket: "clifford-146ae.firebasestorage.app",
    messagingSenderId: "655375890963",
    appId: "1:655375890963:web:0153ed600a917c222c9de6",
    measurementId: "G-LH3WS88L5W"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const eventForm = document.getElementById('eventForm');
  const submitEventBtn = document.getElementById('submitEventBtn');

  loginBtn.onclick = () => signInWithPopup(auth, provider);
  logoutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, user => {
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      toggleFormBtn.disabled = false;
      loadEvents();
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      toggleFormBtn.disabled = true;
      eventForm.style.display = 'none';
      document.getElementById('eventsList').innerHTML = "<em>Please sign in to add/edit events.</em>";
      clearMarkers();
      loadEvents();
    }
  });

  toggleFormBtn.onclick = () => {
    eventForm.style.display = (eventForm.style.display === 'none' ? 'block' : 'none');
  };
  submitEventBtn.onclick = addEvent;
  document.getElementById('allGenres').onchange = loadEvents;
  document.querySelectorAll('.genre').forEach(cb => cb.onchange = loadEvents);

  let map = L.map('map').setView([47.5, 14.5], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  let markers = [];
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 12));
  }

  async function addEvent() {
    const user = auth.currentUser;
    if (!user) return alert("Must sign in to submit!");
    const ev = {
      name: document.getElementById('eventName').value,
      datetime: document.getElementById('eventDateTime').value,
      location: document.getElementById('eventLocation').value,
      genre: document.getElementById('eventGenre').value,
      uid: user.uid,
      email: user.email
    };

    const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ev.location)}`);
    const geoData = await geo.json();
    if (!geoData.length) return alert("Location not found");

    ev.lat = +geoData[0].lat;
    ev.lon = +geoData[0].lon;

    await addDoc(collection(db, "events"), ev);
    eventForm.reset();
    eventForm.style.display = 'none';
    loadEvents();
  }

  async function loadEvents() {
    clearMarkers();
    const now = new Date();
    const evList = document.getElementById('eventsList');
    evList.innerHTML = "";

    const q = query(collection(db, "events"), orderBy("datetime", "asc"));
    const snap = await getDocs(q);

    for (const d of snap.docs) {
      const ev = d.data();
      if (new Date(ev.datetime) < now) {
        await deleteDoc(doc(db, "events", d.id));
        continue;
      }
      if (!isGenreVisible(ev.genre)) continue;

      renderEvent(ev, d.id);
    }
  }

  function renderEvent(ev, id) {
    const container = document.createElement('div');
    container.className = 'event';
    container.innerHTML = `<strong>${ev.name}</strong><br>${ev.datetime.replace("T"," ")} | ${ev.location} | ${ev.genre}<br><span class="author-email">${ev.email}</span>`;

    if (auth.currentUser && auth.currentUser.uid === ev.uid) {
      const btnEdit = document.createElement('button');
      btnEdit.textContent = "✏️";
      btnEdit.className = "action-btn";
      btnEdit.onclick = () => editEvent(id, ev);
      const btnDel = document.createElement('button');
      btnDel.textContent = "🗑️";
      btnDel.className = "action-btn";
      btnDel.onclick = () => deleteDoc(doc(db, "events", id)).then(loadEvents);
      container.append(btnEdit, btnDel);
    }

    document.getElementById('eventsList').append(container);

    const m = L.marker([ev.lat, ev.lon]).addTo(map).bindPopup(`<b>${ev.name}</b><br>${ev.genre}`);
    markers.push(m);
  }

  function clearMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }

  function isGenreVisible(genre) {
    if (document.getElementById('allGenres').checked) return true;
    return Array.from(document.querySelectorAll('.genre:checked')).some(cb => cb.value === genre);
  }

  function editEvent(id, ev) {
    document.getElementById('eventName').value = ev.name;
    document.getElementById('eventDateTime').value = ev.datetime;
    document.getElementById('eventLocation').value = ev.location;
    document.getElementById('eventGenre').value = ev.genre;
    eventForm.style.display = 'block';

    submitEventBtn.textContent = "Save Edit";
    submitEventBtn.onclick = async () => {
      const updates = {
        name: document.getElementById('eventName').value,
        datetime: document.getElementById('eventDateTime').value,
        location: document.getElementById('eventLocation').value,
        genre: document.getElementById('eventGenre').value
      };
      await updateDoc(doc(db, "events", id), updates);
      eventForm.reset();
      submitEventBtn.textContent = "Submit";
      submitEventBtn.onclick = addEvent;
      eventForm.style.display = 'none';
      loadEvents();
    };
  }
</script>
</body>
</html>